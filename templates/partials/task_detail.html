<div id="task-detail-content">

<!-- Auto-refresh wrapper for task info (excludes terminal) -->
<div id="task-info-refresh"
     {% if task.status.value in ['running', 'waiting'] %}
     hx-ext="morph"
     hx-get="/dashboard/tasks/{{ task.id }}"
     hx-trigger="every 3s"
     hx-target="#task-info-refresh"
     hx-select="#task-info-refresh"
     hx-swap="morph:outerHTML"
     {% endif %}>

<div class="panel-header">
    <span>{{ task.title }}</span>
    <span class="task-status status-{{ task.status.value }}">{{ task.status.value }}</span>
</div>

<div class="task-info">
    {% if task.description %}
    <p class="task-description">{{ task.description }}</p>
    {% endif %}

    <div class="info-grid">
        <div class="info-item">
            <span class="label">Stack:</span>
            <span class="value">{{ task.stack_name or 'Not assigned' }}</span>
        </div>
        <div class="info-item">
            <span class="label">Claude:</span>
            <span class="value claude-{{ task.claude_status.value }}">{% if task.status.value == 'pending' and task.claude_status.value == 'stopped' %}Not started{% else %}{{ task.claude_status.value }}{% endif %}</span>
        </div>
        <div class="info-item">
            <span class="label">Restarts:</span>
            <span class="value">{{ task.claude_restarts }}</span>
        </div>
        <div class="info-item">
            <span class="label">Created:</span>
            <span class="value">{{ task.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
        </div>
    </div>
</div>

<!-- Action Buttons -->
<div class="task-actions">
    {% if task.status.value == 'pending' %}
    <div class="start-task-form">
        <input type="text"
               id="initial-prompt-{{ task.id }}"
               placeholder="Initial prompt for Claude (optional)"
               class="message-input">
        <button class="btn btn-primary"
                hx-post="/dashboard/tasks/{{ task.id }}/start"
                hx-target="#task-detail"
                hx-swap="innerHTML"
                hx-include="#initial-prompt-{{ task.id }}"
                hx-vals='js:{initial_prompt: document.getElementById("initial-prompt-{{ task.id }}").value}'>
            Start Task
        </button>
    </div>
    <button class="btn btn-danger"
            hx-delete="/dashboard/tasks/{{ task.id }}"
            hx-target="#task-{{ task.id }}"
            hx-swap="delete"
            hx-confirm="Delete this task?">
        Delete
    </button>

    {% elif task.status.value == 'running' %}
    <button class="btn btn-secondary"
            hx-post="/dashboard/tasks/{{ task.id }}/restart-claude"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Restart Claude
    </button>
    <button class="btn btn-success"
            hx-post="/dashboard/tasks/{{ task.id }}/complete"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Complete
    </button>
    <button class="btn btn-danger"
            hx-post="/dashboard/tasks/{{ task.id }}/fail"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Fail
    </button>

    {% elif task.status.value == 'waiting' %}
    <button class="btn btn-secondary"
            hx-post="/dashboard/tasks/{{ task.id }}/restart-claude"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Restart Claude
    </button>
    <button class="btn btn-success"
            hx-post="/dashboard/tasks/{{ task.id }}/complete"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Complete
    </button>
    <button class="btn btn-danger"
            hx-post="/dashboard/tasks/{{ task.id }}/fail"
            hx-target="#task-detail"
            hx-swap="innerHTML">
        Fail
    </button>
    {% if task.permission_prompt %}
    <div class="permission-prompt">{{ task.permission_prompt }}</div>
    {% endif %}

    {% elif task.status.value == 'completed' or task.status.value == 'failed' %}
    <button class="btn btn-danger"
            hx-delete="/dashboard/tasks/{{ task.id }}"
            hx-target="#task-{{ task.id }}"
            hx-swap="delete"
            hx-confirm="Delete this task?">
        Delete
    </button>
    {% if task.result %}
    <div class="task-result">
        <strong>Result:</strong> {{ task.result }}
    </div>
    {% endif %}
    {% endif %}
</div>

</div><!-- end task-info-refresh -->

<!-- Terminal (for running tasks) - outside refresh zone -->
{% if task.status.value in ['running', 'waiting'] %}
    {% if tmux_session_exists %}
    <div class="terminal-section">
        <div class="terminal-header">
            <span>Terminal</span>
            <a href="http://localhost:{{ 7681 + task.id }}" target="_blank" class="btn btn-small">
                Open in New Tab
            </a>
        </div>
        <iframe
            id="terminal-iframe-{{ task.id }}"
            src="http://localhost:{{ 7681 + task.id }}"
            class="terminal-iframe"
            title="Task Terminal">
        </iframe>

        <!-- Send Message Form -->
        <form class="send-form" hx-post="/dashboard/tasks/{{ task.id }}/send" hx-swap="none">
            <input type="text"
                   name="message"
                   placeholder="Send a message to Claude (Ctrl/Cmd+Enter to send)"
                   class="message-input"
                   autocomplete="off">
            <button type="submit" class="btn btn-primary">Send</button>
        </form>
    </div>
    {% else %}
    <div class="terminal-section">
        <div class="terminal-error">
            <strong>Error:</strong> tmux session not found. The terminal session should be alive throughout the task lifecycle.
        </div>
    </div>
    {% endif %}
{% endif %}

</div><!-- end task-detail-content -->
